name: Run Automated Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    # –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–¥–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # –ü–æ–ª—É—á–∞–µ–º –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∫–æ–º–º–∏—Ç–æ–≤
      
    # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    # –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞
    - name: Check project structure
      run: |
        echo "üìÅ Current directory: $(pwd)"
        echo "üìÅ Listing files:"
        ls -la
        echo ""
        echo "üìÅ Checking test files:"
        ls -la *.py || echo "No .py files found"
        echo ""
        echo "üìÑ Checking requirements.txt:"
        if [ -f requirements.txt ]; then
          echo "‚úÖ requirements.txt exists"
          cat requirements.txt
        else
          echo "‚ö†Ô∏è  requirements.txt not found"
        fi
        
    # –®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    - name: Install dependencies
      run: |
        echo "üì¶ Upgrading pip..."
        python -m pip install --upgrade pip
        echo "üì¶ Pip version: $(pip --version)"
        
        echo ""
        echo "üì¶ Installing from requirements.txt..."
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          echo "üì¶ requirements.txt not found, installing basic packages..."
          pip install selenium pytest webdriver-manager
        fi
        
        echo ""
        echo "üì¶ Installed packages:"
        pip list | grep -E "(selenium|pytest|webdriver)"
        
    # –®–∞–≥ 5: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Chrome
    - name: Set up Chrome
      uses: browser-actions/setup-chrome@v1
      
    # –®–∞–≥ 6: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Chrome
    - name: Verify Chrome installation
      run: |
        echo "üåê Checking Chrome installation..."
        if command -v google-chrome &> /dev/null; then
          echo "‚úÖ Chrome is installed"
          google-chrome --version
        else
          echo "‚ùå Chrome not found"
        fi
        
        echo ""
        echo "üîß Checking ChromeDriver..."
        if command -v chromedriver &> /dev/null; then
          echo "‚úÖ ChromeDriver is installed"
          chromedriver --version
        else
          echo "‚ö†Ô∏è  ChromeDriver not in PATH"
        fi
      
    # –®–∞–≥ 7: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
    - name: Run tests with pytest
      run: |
        echo "üß™ Starting test execution..."
        echo "üß™ Python version: $(python --version)"
        echo "üß™ pytest version: $(pytest --version)"
        
        echo ""
        echo "üß™ Available test files:"
        ls test_*.py 2>/dev/null || echo "No test_*.py files found"
        
        echo ""
        echo "üß™ Running tests..."
        python -m pytest test_positive.py test_negative.py \
          -v \
          --tb=short \
          --color=yes \
          --durations=5 \
          --html=test-report.html \
          --self-contained-html
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        TEST_EXIT_CODE=$?
        echo "üß™ Test exit code: $TEST_EXIT_CODE"
        
        if [ $TEST_EXIT_CODE -eq 0 ]; then
          echo "‚úÖ All tests passed!"
        else
          echo "‚ùå Some tests failed"
        fi
        
        exit $TEST_EXIT_CODE
        
    # –®–∞–≥ 8: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
    - name: Create detailed test summary
      if: always()
      run: |
        echo "# üìä Detailed Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## üóìÔ∏è Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Date & Time:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ‚öôÔ∏è Environment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Runner OS:** ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Python Version:** $(python --version)" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## üìà Test Statistics" >> $GITHUB_STEP_SUMMARY
        if [ -f .pytest_cache/v/cache/lastfailed ]; then
          echo "‚ùå Some tests failed in previous run" >> $GITHUB_STEP_SUMMARY
        else
          echo "‚úÖ No previously failed tests" >> $GITHUB_STEP_SUMMARY
        fi
        
    # –®–∞–≥ 9: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts-${{ github.run_id }}
        path: |
          test-report.html
          .pytest_cache/
        retention-days: 7
        
    # –®–∞–≥ 10: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ
    - name: Collect debug information on failure
      if: failure()
      run: |
        echo "üîç Collecting debug information..."
        mkdir -p debug-info
        
        echo "### System Information ###" > debug-info/system-info.txt
        uname -a >> debug-info/system-info.txt
        echo "" >> debug-info/system-info.txt
        
        echo "### Python Information ###" >> debug-info/system-info.txt
        python --version >> debug-info/system-info.txt
        python -c "import sys; print('Python path:', sys.path)" >> debug-info/system-info.txt
        echo "" >> debug-info/system-info.txt
        
        echo "### Installed Packages ###" >> debug-info/system-info.txt
        pip list >> debug-info/system-info.txt
        echo "" >> debug-info/system-info.txt
        
        echo "### Chrome Information ###" >> debug-info/system-info.txt
        google-chrome --version >> debug-info/system-info.txt 2>/dev/null || echo "Chrome not available" >> debug-info/system-info.txt
        echo "" >> debug-info/system-info.txt
        
        echo "### Directory Structure ###" >> debug-info/system-info.txt
        find . -name "*.py" -type f | head -20 >> debug-info/system-info.txt
        echo "" >> debug-info/system-info.txt
        
        echo "### Test Files Content ###" >> debug-info/system-info.txt
        for file in test_*.py; do
          if [ -f "$file" ]; then
            echo "=== $file ===" >> debug-info/system-info.txt
            head -20 "$file" >> debug-info/system-info.txt
            echo "" >> debug-info/system-info.txt
          fi
        done
        
        echo "‚úÖ Debug information collected"
        
    - name: Upload debug information
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: debug-info-${{ github.run_id }}
        path: debug-info/
        retention-days: 7
        
    # –®–∞–≥ 11: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    - name: Final status message
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "üéâ All steps completed successfully!"
          echo "‚úÖ Workflow execution: SUCCESS"
        else
          echo "‚ö†Ô∏è  Workflow completed with issues"
          echo "‚ùå Workflow execution: FAILED"
          echo "Check the logs above for details."
        fi