name: Run Automated Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    # Получение кода из репозитория
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  
      
    # Установка Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        
    # Проверка структуры проекта
    - name: Check project structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Listing files:"
        ls -la
        echo ""
        echo "Checking test files:"
        ls -la *.py || echo "No .py files found"
        echo ""
        fi
        
    # Установка зависимостей
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        echo " Pip version: $(pip --version)"
        
        echo ""
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          pip install selenium pytest webdriver-manager
        fi
        pip list | grep -E "(selenium|pytest|webdriver)"
        
    # Установка Chrome
    - name: Set up Chrome
      uses: browser-actions/setup-chrome@v1
      
    # Проверка установки Chrome
    - name: Verify Chrome installation
      run: |
        if command -v google-chrome &> /dev/null; then
          echo "Chrome is installed"
          google-chrome --version
        else
          echo "Chrome not found"
        fi
        
        echo ""
        if command -v chromedriver &> /dev/null; then
          echo "ChromeDriver is installed"
          chromedriver --version
        else
          echo "ChromeDriver not in PATH"
        fi
      
    # Запуск тестов 
    - name: Run tests with pytest
      run: |
        echo "Python version: $(python --version)"
        echo "pytest version: $(pytest --version)"
        
        echo ""
        echo "Available test files:"
        ls test_*.py 2>/dev/null || echo "No test_*.py files found"
        
        echo ""
        python -m pytest test_positive.py test_negative.py \
          -v \
          --tb=short \
          --color=yes \
          --durations=5 \
          --html=test-report.html \
          --self-contained-html
        
        # Сохраняем код завершения
        TEST_EXIT_CODE=$?
        echo "Test exit code: $TEST_EXIT_CODE"
        
        if [ $TEST_EXIT_CODE -eq 0 ]; then
          echo "All tests passed"
        else
          echo "Some tests failed"
        fi
        
        exit $TEST_EXIT_CODE
        
    # Генерация отчета
    - name: Create detailed test summary
      if: always()
      run: |
        echo "# Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "## Execution Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Date & Time:** $(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "- **Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})" >> $GITHUB_STEP_SUMMARY
        echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Environment Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Runner OS:** ${{ runner.os }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Python Version:** $(python --version)" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Test Statistics" >> $GITHUB_STEP_SUMMARY
        if [ -f .pytest_cache/v/cache/lastfailed ]; then
          echo "Some tests failed in previous run" >> $GITHUB_STEP_SUMMARY
        else
          echo "All tests OK" >> $GITHUB_STEP_SUMMARY
        fi
        

    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-artifacts-${{ github.run_id }}
        path: |
          test-report.html
          .pytest_cache/
        retention-days: 7
               
    # 
    - name: Final status message
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "All steps completed successfully"
          echo "Workflow execution: SUCCESS"
        else
          echo " Workflow completed with issues"
          echo "Workflow execution: FAILED"
          echo "Check the logs above for details."
        fi